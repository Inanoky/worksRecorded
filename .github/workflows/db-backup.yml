name: DB Backup

on:
  schedule:
    - cron: "0 */2 * * *"   # every 2 hours UTC
  workflow_dispatch: {}

jobs:
  dump:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare output dir
        run: mkdir -p backups

      - name: Dump database with Postgres 17 (Docker)
        run: |
          TS=$(date -u +"%Y%m%d_%H%M%S")
          FILE="db_${TS}.dump"

          docker run --rm \
            -e PGPASSWORD='${{ secrets.PG_PASSWORD }}' \
            -e PGSSLMODE='require' \
            -v "$PWD/backups":/backups \
            postgres:17 \
            bash -lc "pg_dump \
              -h '${{ secrets.PG_HOST }}' \
              -p '${{ secrets.PG_PORT }}' \
              -U '${{ secrets.PG_USER }}' \
              -d '${{ secrets.PG_DATABASE }}' \
              -Fc -f '/backups/$FILE'"

          ls -lh backups

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup
          path: backups/*.dump
          retention-days: 60
